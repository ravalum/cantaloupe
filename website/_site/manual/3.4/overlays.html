<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="High-performance IIIF image server in Java
">

  <title>
    Cantaloupe Image Server
    
      :: Overlays
    
  </title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/cantaloupe/css/syntax.css">
  <link rel="stylesheet" href="/cantaloupe/css/base.css">

  <script src="/cantaloupe/scripts/jquery.min.js"></script>

  <script>
  // Redirect http:// to https:// (except on localhost)
  var host = 'http://0.0.0.0:4000'.replace('http://', '').
      replace('https://', '').split(/[/?#]/)[0];
  if (window.location.host == host && window.location.protocol != 'https:') {
    window.location.protocol = 'https:';
  }
  </script>

</head>


  <body>

    <nav class="navbar navbar-default">
  <div class="container-fluid">

    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/cantaloupe/">
        <img alt="Cantaloupe" src="/cantaloupe/images/cantaloupe.png" width="40">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Get Started <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/cantaloupe/get-started.html">For the First Time</a></li>
            <li><a href="/cantaloupe/upgrade.html">Upgrade</a></li>
            <li class="divider"></li>
            <li><a href="/cantaloupe/changes.html">Change Log</a></li>
          </ul>
        </li>
        <li><a href="/cantaloupe/manual/">User Manual</a></li>
        <li><a href="https://github.com/medusa-project/cantaloupe/">GitHub</a></li>
        <li><a href="/cantaloupe/help.html">Help &amp; Feedback</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/medusa-project/cantaloupe/releases.atom" title="Subscribe to Releases"><img width="22" height="22" src="/cantaloupe/images/feed.svg"></a></li>
      </ul>
    </div>

  </div>
</nav>


    <div class="container">
      <ul class="nav nav-pills">
  <li role="presentation"  class="active" ><a href="/cantaloupe/manual/3.4/">3.4</a></li>
  <li role="presentation" ><a href="/cantaloupe/manual/3.3/">3.3</a></li>
  <li role="presentation" ><a href="/cantaloupe/manual/3.2/">3.2</a></li>
  <li role="presentation" ><a href="/cantaloupe/manual/3.1/">3.1</a></li>
  <li role="presentation" ><a href="/cantaloupe/manual/3.0/">3.0</a></li>
  <li role="presentation" ><a href="/cantaloupe/manual/2.2/">2.2</a></li>
  <li role="presentation" ><a href="/cantaloupe/manual/2.1/">2.1</a></li>
</ul>


<h1>User Manual <small class="version">3.4</small></h1>

<div class="row">
  <div class="col-md-3 hidden-xs hidden-sm">
    <ul class="nav nav-pills nav-stacked">
  <li role="presentation" >
    <a href="getting-started.html">Getting Started</a>
  </li>
  <li role="presentation" >
    <a href="configuration.html">Configuration</a>
  </li>
  <li role="presentation" >
    <a href="endpoints.html">Endpoints</a>
  </li>
  <li role="presentation" >
    <a href="images.html">Images</a>
  </li>
  <li role="presentation" >
    <a href="resolvers.html">Resolvers</a>
  </li>
  <li role="presentation" >
    <a href="processors.html">Processors</a>
  </li>
  <li role="presentation" >
    <a href="caching.html">Caching</a>
  </li>
  <li role="presentation" >
    <a href="access-control.html">Access Control</a>
  </li>
  <li role="presentation" >
    <a href="delegate-script.html">Delegate Script</a>
  </li>
  <li role="presentation"  class="active" >
    <a href="overlays.html">Overlays</a>
  </li>
  <li role="presentation" >
    <a href="redaction.html">Redaction</a>
  </li>
  <li role="presentation" >
    <a href="logging.html">Logging</a>
  </li>
  <li role="presentation" >
    <a href="deployment.html">Deployment</a>
  </li>
  <li role="presentation" >
    <a href="remote-management.html">Remote Management</a>
  </li>
</ul>

  </div>
  <div class="col-sm-12 col-md-9">
    <h1>Overlays</h1>

<ul>
  <li><a href="#Image%20Overlays">Image Overlays</a></li>
  <li><a href="#String%20Overlays">String Overlays</a></li>
  <li><a href="#Modes%20of%20Operation">Modes of Operation</a>
    <ul>
        <li><a href="#BasicStrategy">BasicStrategy</a></li>
        <li><a href="#ScriptStrategy">ScriptStrategy</a></li>
    </ul>
  </li>
  <li><a href="#Positioning">Positioning</a></li>
  <li><a href="#Implications%20for%20Zooming%20Viewers">Implications for Zooming Viewers</a></li>
</ul>

<p>The overlay feature overlays an image or text string on top of a derivative (output) image. This can be useful for description, branding, attribution, copyright notices, and so on.</p>

<figure>
  <img src="images/image-overlay-1600.jpg" class="img img-responsive" alt="Image with image overlay applied.">
  <figcaption>Image overlay.</figcaption>
</figure>

<figure>
  <img src="images/string-overlay-1600.jpg" class="img img-responsive" alt="Image with string overlay applied.">
  <figcaption>String overlay.</figcaption>
</figure>

<p>With both types of overlays, the position, inset, and output width/height threshold (below which the overlay won't be displayed) are configurable.</p>

<p>Not all processors support overlays; see the <a href="processors.html#Supported%20Features">table of supported features</a>.</p>

<hr>

<h2 id="Image Overlays">Image Overlays</h2>

<p>An image overlay must be a 24-bit PNG image, either RGB or RGBA. It will be blended pixel-for-pixel into the output image.</p>

<p>Overlay images can be located on the filesystem, and also, since version 3.3, on a web server. Regardless, they are cached in memory after being loaded the first time, so there is no performance penalty for using web-hosted overlay images.</p>

<div class="alert alert-info">Note: when using multiple image overlays, their filenames must all be different, regardless of where they reside.</div>

<p><a href="images/overlay-sample.png">Sample overlay image (PNG)</a></p>

<hr>

<h2 id="String Overlays">String Overlays</h2>

<p>String overlays are dynamically rendered onto an image using Java 2D. The font family, size, weight, color, stroke color, background color and opacity, etc., are configurable.</p>

<p>Line breaks within the string (<code>\n</code>) are respected, enabling multi-line strings. Each line is auto-aligned to the edge of the image according to the <a href="#Positioning">overlay position</a>.</p>

<p>Strings are guaranteed to never overflow outside of the image. When a string doesn't fit entirely inside at its specified font size, the image server will try to use the largest font size that fits, down to the configurable minimum allowed size. If none fit, the string won't be drawn.</p>

<hr>

<h2 id="Modes of Operation">Modes of Operation</h2>

<p>The overlay system offers two "strategies," or modes of operation: a basic strategy, where overlay properties are hard-coded in the configuration file and applied to all requests; and a <a href="#ScriptStrategy">script strategy</a>, where the decision of whether to apply an overlay, and what kind, depends on the return value of a delegate method. The <code>overlays.strategy</code> configuration key is used to set the strategy.</p>

<h3 id="BasicStrategy">BasicStrategy</h3>

<p>With BasicStrategy, the <code>overlays.BasicStrategy.*</code> keys in the configuration file are used to set an overlay type (image or string), position, inset, and others. This strategy is easy to configure and is all that is needed when it is intended for the same overlay to be applied to all images.</p>

<h3 id="ScriptStrategy">ScriptStrategy</h3>

<p>Perhaps you want to apply an image overlay to some of your images, and to others, you want to apply a string overlay, or no overlay. Perhaps you want to control overlays based on the client's IP address or user agent. Or, perhaps you only want to apply overlays to JPEG output images, and not GIFs. Or, perhaps you don't want to apply an overlay to images that have been rotated. All of this is possible by writing just a few lines of code.</p>

<p>With the <code>overlay()</code> delegate method, you can tell the image server whether to apply an overlay in response to a particular request, and what its properties should be. As an example:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="c1">##</span>
  <span class="c1"># See the argument &amp; return value documentation in delegates.rb.sample.</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">overlay</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span>
                   <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">cookies</span><span class="p">)</span>
    <span class="c1"># If the resulting image is less than this many pixels on a side, don't</span>
    <span class="c1"># apply an overlay.</span>
    <span class="n">min_size_cutoff</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">resulting_size</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_size_cutoff</span> <span class="n">or</span>
        <span class="n">resulting_size</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_size_cutoff</span>

    <span class="c1"># Don't render an overlay for clients on localhost.</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="sx">%w(127.0.0.1 ::1/128)</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>

    <span class="c1"># Don't render an overlay on GIF images.</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">output_format</span><span class="p">[</span><span class="s1">'media_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'image/gif'</span>

    <span class="c1"># Don't render an overlay on images of cantaloupes.</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">identifier</span><span class="p">.</span><span class="nf">downcase</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s1">'cantaloupe'</span><span class="p">)</span>

    <span class="c1"># Render an image overlay for iOS clients.</span>
    <span class="k">if</span> <span class="n">request_headers</span><span class="p">.</span>
        <span class="nf">select</span><span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">k</span><span class="p">.</span><span class="nf">downcase</span> <span class="o">==</span> <span class="s1">'user-agent'</span> <span class="n">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s1">'iOS'</span><span class="p">)</span> <span class="p">}.</span><span class="nf">any?</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="s1">'image'</span> <span class="o">=&gt;</span> <span class="s1">'/path/to/ios-overlay.png'</span><span class="p">,</span>
        <span class="s1">'position'</span> <span class="o">=&gt;</span> <span class="s1">'bottom right'</span><span class="p">,</span>
        <span class="s1">'inset'</span> <span class="o">=&gt;</span> <span class="mi">5</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="c1"># Render a string overlay for all other clients.</span>
    <span class="p">{</span>
      <span class="s1">'string'</span> <span class="o">=&gt;</span> <span class="s2">"This string</span><span class="se">\n</span><span class="s2">has multiple lines"</span><span class="p">,</span>
      <span class="s1">'position'</span> <span class="o">=&gt;</span> <span class="s1">'bottom left'</span><span class="p">,</span>
      <span class="s1">'inset'</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s1">'font'</span> <span class="o">=&gt;</span> <span class="s1">'Helvetica'</span><span class="p">,</span>
      <span class="s1">'font_size'</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
      <span class="s1">'font_min_size'</span> <span class="o">=&gt;</span> <span class="mi">18</span><span class="p">,</span>
      <span class="s1">'font_weight'</span> <span class="o">=&gt;</span> <span class="mf">1.0</span><span class="p">,</span>
      <span class="s1">'color'</span> <span class="o">=&gt;</span> <span class="s1">'white'</span><span class="p">,</span>
      <span class="s1">'background_color'</span> <span class="o">=&gt;</span> <span class="s1">'rgba(0, 0, 0, 0.6)'</span>
      <span class="s1">'glyph_spacing'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s1">'stroke_color'</span> <span class="o">=&gt;</span> <span class="s1">'black'</span><span class="p">,</span>
      <span class="s1">'stroke_width'</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<hr>

<h2 id="Positioning">Positioning</h2>

<p>Position and inset are configurable. Supported positions are:</p>

<table class="table text-center">
  <tr>
    <td>
      <code>top left</code>
    </td>
    <td>
      <code>top center</code>
    </td>
    <td>
      <code>top right</code>
    </td>
  </tr>
  <tr>
    <td>
      <code>left center</code>
    </td>
    <td>
      <code>center</code>
    </td>
    <td>
      <code>right center</code>
    </td>
  </tr>
  <tr>
    <td>
      <code>bottom left</code>
    </td>
    <td>
      <code>bottom center</code>
    </td>
    <td>
      <code>bottom right</code>
    </td>
  </tr>
</table>

<hr>

<h2 id="Implications for Zooming Viewers">Implications for Zooming Viewers</h2>

<p>Zooming image viewers display a mosaic of cropped image tiles. When overlays are enabled, each tile will have one, which is bound to look strange. A couple of ways to work around this are:</p>

<ul>
  <li>Set the <code>overlays.BasicStrategy.output_width_threshold</code> and <code>overlays.BasicStrategy.output_height_threshold</code> configuration options to values that are slightly larger than the tile size used by the image viewer. This will disable overlays for images the size of image viewer tiles, and enable them for anything larger. Bear in mind, though, that the tile size used by the viewer may differ depending on the source image, as the recommended tile sizes in <a href="endpoints.html">information responses</a> will vary on a per-image basis.</li>
  <li>Have the zooming viewer supply a URI query argument, and check for it in the <code>overlay()</code> delegate method. Of course, a user could figure this out and supply the same argument in other image requests to bypass overlays arbitrarily.</li>
</ul>

  </div>
</div>


      <footer>
</footer>

<script src="/cantaloupe/scripts/bootstrap.min.js"></script>
<script src="/cantaloupe/scripts/base.js"></script>

    </div>

  </body>

</html>
